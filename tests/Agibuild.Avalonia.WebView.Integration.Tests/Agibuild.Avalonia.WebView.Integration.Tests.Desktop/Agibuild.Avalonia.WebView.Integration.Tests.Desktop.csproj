<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <!--If you are willing to use platform-specific APIs, use conditional compilation.
    See https://docs.avaloniaui.net/docs/guides/platforms/platform-specific-code/dotnet for more details.-->
    <TargetFramework>net10.0</TargetFramework>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <PropertyGroup>
    <ApplicationManifest>app.manifest</ApplicationManifest>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Avalonia.Desktop" />
    <!--Condition below is needed to remove Avalonia.Diagnostics package from build output in Release configuration.-->
    <PackageReference Include="Avalonia.Diagnostics" >
      <IncludeAssets Condition="'$(Configuration)' != 'Debug'">None</IncludeAssets>
      <PrivateAssets Condition="'$(Configuration)' != 'Debug'">All</PrivateAssets>
    </PackageReference>
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\Agibuild.Avalonia.WebView.Integration.Tests\Agibuild.Avalonia.WebView.Integration.Tests.csproj" />
  </ItemGroup>

  <!-- Windows: use project reference so NuGet deps (WebView2) are in deps.json -->
  <ItemGroup Condition="$([MSBuild]::IsOSPlatform('windows'))">
    <ProjectReference Include="..\..\..\src\Agibuild.Avalonia.WebView.Adapters.Windows\Agibuild.Avalonia.WebView.Adapters.Windows.csproj" />
  </ItemGroup>

  <!-- Linux: copy GTK adapter and native shim so the adapter auto-registers at runtime -->
  <Target Name="CopyLinuxGtkAdapterForSmoke"
          AfterTargets="Build"
          Condition="$([MSBuild]::IsOSPlatform('linux'))">
    <ItemGroup>
      <_GtkAdapter Include="..\..\..\src\Agibuild.Avalonia.WebView.Adapters.Gtk\bin\$(Configuration)\net10.0\Agibuild.Avalonia.WebView.Adapters.Gtk.dll" />
      <_GtkShim Include="..\..\..\src\Agibuild.Avalonia.WebView.Adapters.Gtk\bin\$(Configuration)\net10.0\runtimes\linux-x64\native\libAgibuildWebViewGtk.so" />
    </ItemGroup>

    <Exec Command="dotnet build &quot;..\..\..\src\Agibuild.Avalonia.WebView.Adapters.Gtk\Agibuild.Avalonia.WebView.Adapters.Gtk.csproj&quot; -c $(Configuration)" />

    <Copy SourceFiles="@(_GtkAdapter)"
          DestinationFolder="$(OutDir)"
          SkipUnchangedFiles="true" />

    <MakeDir Directories="$(OutDir)runtimes/linux-x64/native/" />
    <Copy SourceFiles="@(_GtkShim)"
          DestinationFolder="$(OutDir)runtimes/linux-x64/native/"
          SkipUnchangedFiles="true" />
  </Target>

  <Target Name="CopyMacOSWebViewAdapterForSmoke"
          AfterTargets="Build"
          Condition="$([MSBuild]::IsOSPlatform('osx'))">
    <ItemGroup>
      <_MacAdapter Include="..\..\..\src\Agibuild.Avalonia.WebView.Adapters.MacOS\bin\$(Configuration)\net10.0\Agibuild.Avalonia.WebView.Adapters.MacOS.dll" />
      <_MacShim Include="..\..\..\src\Agibuild.Avalonia.WebView.Adapters.MacOS\bin\$(Configuration)\net10.0\runtimes\osx\native\libAgibuildWebViewWk.dylib" />
    </ItemGroup>

    <Exec Command="dotnet build &quot;..\..\..\src\Agibuild.Avalonia.WebView.Adapters.MacOS\Agibuild.Avalonia.WebView.Adapters.MacOS.csproj&quot; -c $(Configuration)" />

    <Copy SourceFiles="@(_MacAdapter)"
          DestinationFolder="$(OutDir)"
          SkipUnchangedFiles="true" />

    <MakeDir Directories="$(OutDir)runtimes/osx/native/" />
    <Copy SourceFiles="@(_MacShim)"
          DestinationFolder="$(OutDir)runtimes/osx/native/"
          SkipUnchangedFiles="true" />
  </Target>
</Project>
