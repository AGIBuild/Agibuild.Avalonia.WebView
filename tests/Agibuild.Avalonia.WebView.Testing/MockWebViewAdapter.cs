using Avalonia.Platform;
using Agibuild.Avalonia.WebView;
using Agibuild.Avalonia.WebView.Adapters.Abstractions;

namespace Agibuild.Avalonia.WebView.Testing;

internal class MockWebViewAdapter : IWebViewAdapter
{
    private IWebViewAdapterHost? _host;
    private bool _initialized;
    private bool _attached;
    private bool _detached;

    // In-memory cookie store keyed by "name|domain|path" (used by MockWebViewAdapterWithCookies)
    protected readonly Dictionary<string, WebViewCookie> CookieStore = new();

    /// <summary>Creates a mock without cookie support. Use <see cref="CreateWithCookies"/> for cookie-enabled mock.</summary>
    public static MockWebViewAdapter Create() => new();

    /// <summary>Creates a mock that also implements <see cref="ICookieAdapter"/>.</summary>
    public static MockWebViewAdapterWithCookies CreateWithCookies() => new();

    public Guid? LastNavigationId { get; private set; }
    public Uri? LastNavigationUri { get; private set; }
    public Uri? LastBaseUrl { get; private set; }
    public int? LastNavigateThreadId { get; private set; }
    public int? LastNavigateToStringThreadId { get; private set; }
    public int? LastInvokeScriptThreadId { get; private set; }
    public string? ScriptResult { get; set; }
    public Exception? ScriptException { get; set; }

    /// <summary>Optional callback invoked on every InvokeScriptAsync call. Return value overrides ScriptResult.</summary>
    public Func<string, string?>? ScriptCallback { get; set; }

    /// <summary>The last script passed to InvokeScriptAsync.</summary>
    public string? LastScript { get; private set; }

    public bool CanGoBack { get; set; }
    public bool CanGoForward { get; set; }

    public event EventHandler<NavigationCompletedEventArgs>? NavigationCompleted;
    public event EventHandler<NewWindowRequestedEventArgs>? NewWindowRequested;
    public event EventHandler<WebMessageReceivedEventArgs>? WebMessageReceived;
    public event EventHandler<WebResourceRequestedEventArgs>? WebResourceRequested;
    public event EventHandler<EnvironmentRequestedEventArgs>? EnvironmentRequested;

    public void Initialize(IWebViewAdapterHost host)
    {
        if (_initialized)
        {
            throw new InvalidOperationException("Initialize can only be called once.");
        }

        _host = host ?? throw new ArgumentNullException(nameof(host));
        _initialized = true;
    }

    public void Attach(IPlatformHandle parentHandle)
    {
        if (!_initialized)
        {
            throw new InvalidOperationException("Attach requires Initialize first.");
        }

        if (_attached)
        {
            throw new InvalidOperationException("Attach can only be called once.");
        }

        _attached = true;
        AttachCallCount++;
    }

    public void Detach()
    {
        if (!_attached)
        {
            throw new InvalidOperationException("Detach requires Attach first.");
        }

        if (_detached)
        {
            throw new InvalidOperationException("Detach can only be called once.");
        }

        _detached = true;
        DetachCallCount++;
    }

    /// <summary>
    /// When true, NavigateAsync automatically raises NavigationCompleted(Success)
    /// and then calls <see cref="OnNavigationAutoCompleted"/> if set.
    /// Useful for integration-style tests like WebAuthBroker flows.
    /// </summary>
    public bool AutoCompleteNavigation { get; set; }

    /// <summary>Callback invoked after auto-completing navigation. Use to simulate post-navigation events.</summary>
    public Action? OnNavigationAutoCompleted { get; set; }

    public Task NavigateAsync(Guid navigationId, Uri uri)
    {
        LastNavigateThreadId = Environment.CurrentManagedThreadId;
        LastNavigationId = navigationId;
        LastNavigationUri = uri;

        if (AutoCompleteNavigation)
        {
            RaiseNavigationCompleted(NavigationCompletedStatus.Success);
            OnNavigationAutoCompleted?.Invoke();
        }

        return Task.CompletedTask;
    }

    public Task NavigateToStringAsync(Guid navigationId, string html)
        => NavigateToStringAsync(navigationId, html, baseUrl: null);

    public Task NavigateToStringAsync(Guid navigationId, string html, Uri? baseUrl)
    {
        LastNavigateToStringThreadId = Environment.CurrentManagedThreadId;
        LastNavigationId = navigationId;
        LastNavigationUri = null;
        LastBaseUrl = baseUrl;

        if (AutoCompleteNavigation)
        {
            RaiseNavigationCompleted(NavigationCompletedStatus.Success);
            OnNavigationAutoCompleted?.Invoke();
        }

        return Task.CompletedTask;
    }

    public Task<string?> InvokeScriptAsync(string script)
    {
        LastInvokeScriptThreadId = Environment.CurrentManagedThreadId;
        LastScript = script;

        if (ScriptException is not null)
        {
            return Task.FromException<string?>(ScriptException);
        }

        if (ScriptCallback is not null)
        {
            return Task.FromResult(ScriptCallback(script));
        }

        return Task.FromResult(ScriptResult);
    }

    public int AttachCallCount { get; private set; }
    public int DetachCallCount { get; private set; }
    public int StopCallCount { get; private set; }

    public bool GoBackAccepted { get; set; }
    public bool GoForwardAccepted { get; set; }
    public bool RefreshAccepted { get; set; }
    public bool StopAccepted { get; set; }

    public int GoBackCallCount { get; private set; }
    public int GoForwardCallCount { get; private set; }
    public int RefreshCallCount { get; private set; }

    public Guid? LastGoBackNavigationId { get; private set; }
    public Guid? LastGoForwardNavigationId { get; private set; }
    public Guid? LastRefreshNavigationId { get; private set; }

    public bool GoBack(Guid navigationId)
    {
        GoBackCallCount++;
        LastGoBackNavigationId = navigationId;
        LastNavigationId = navigationId;
        return GoBackAccepted;
    }

    public bool GoForward(Guid navigationId)
    {
        GoForwardCallCount++;
        LastGoForwardNavigationId = navigationId;
        LastNavigationId = navigationId;
        return GoForwardAccepted;
    }

    public bool Refresh(Guid navigationId)
    {
        RefreshCallCount++;
        LastRefreshNavigationId = navigationId;
        LastNavigationId = navigationId;
        return RefreshAccepted;
    }

    public bool Stop()
    {
        StopCallCount++;
        return StopAccepted;
    }

    public ValueTask<NativeNavigationStartingDecision> SimulateNativeNavigationStartingAsync(
        Uri requestUri,
        Guid? correlationId = null,
        bool isMainFrame = true)
    {
        if (_detached)
        {
            return ValueTask.FromResult(new NativeNavigationStartingDecision(IsAllowed: false, NavigationId: Guid.Empty));
        }

        if (_host is null)
        {
            throw new InvalidOperationException("Initialize(IWebViewAdapterHost) must be called before simulating native navigation.");
        }

        var info = new NativeNavigationStartingInfo(
            CorrelationId: correlationId ?? Guid.NewGuid(),
            RequestUri: requestUri,
            IsMainFrame: isMainFrame);

        return InvokeAsync();

        async ValueTask<NativeNavigationStartingDecision> InvokeAsync()
        {
            var decision = await _host.OnNativeNavigationStartingAsync(info).ConfigureAwait(false);
            if (decision.IsAllowed && decision.NavigationId != Guid.Empty)
            {
                LastNavigationId = decision.NavigationId;
                LastNavigationUri = requestUri;
            }

            return decision;
        }
    }

    public void RaiseNavigationCompleted()
    {
        if (_detached)
        {
            return;
        }

        RaiseNavigationCompleted(NavigationCompletedStatus.Success);
    }

    public void RaiseNavigationCompleted(Guid navigationId, Uri requestUri, NavigationCompletedStatus status, Exception? error = null)
    {
        if (_detached)
        {
            return;
        }

        var args = new NavigationCompletedEventArgs(
            navigationId,
            requestUri,
            status,
            status == NavigationCompletedStatus.Failure ? error ?? new Exception("Navigation failed.") : null);
        NavigationCompleted?.Invoke(this, args);
    }

    /// <summary>Raises NavigationCompleted with exact args (no auto-fill).</summary>
    public void RaiseNavigationCompletedRaw(NavigationCompletedEventArgs args)
    {
        if (_detached) return;
        NavigationCompleted?.Invoke(this, args);
    }

    public void RaiseNavigationCompleted(NavigationCompletedStatus status, Exception? error = null)
    {
        var navigationId = LastNavigationId ?? Guid.Empty;
        var requestUri = LastNavigationUri ?? new Uri("about:blank");
        RaiseNavigationCompleted(navigationId, requestUri, status, error);
    }

    public void RaiseNewWindowRequested(Uri? uri = null)
    {
        if (_detached) return;
        NewWindowRequested?.Invoke(this, new NewWindowRequestedEventArgs(uri));
    }

    public void RaiseWebMessage(string body, string origin, Guid channelId, int protocolVersion = 1)
    {
        if (_detached)
        {
            return;
        }

        WebMessageReceived?.Invoke(this, new WebMessageReceivedEventArgs(body, origin, channelId, protocolVersion));
    }

    public void RaiseWebResourceRequested()
    {
        if (_detached) return;
        WebResourceRequested?.Invoke(this, new WebResourceRequestedEventArgs());
    }

    public void RaiseEnvironmentRequested()
    {
        if (_detached) return;
        EnvironmentRequested?.Invoke(this, new EnvironmentRequestedEventArgs());
    }

    protected static string CookieKey(string name, string domain, string path) => $"{name}|{domain}|{path}";

    /// <summary>Creates a mock that supports environment options.</summary>
    public static MockWebViewAdapterWithOptions CreateWithOptions() => new();

    /// <summary>Creates a mock that supports native handle provider.</summary>
    public static MockWebViewAdapterWithHandle CreateWithHandle() => new();

    /// <summary>Creates a mock that supports custom scheme registration.</summary>
    public static MockWebViewAdapterWithCustomSchemes CreateWithCustomSchemes() => new();

    /// <summary>Creates a mock that supports download events.</summary>
    public static MockWebViewAdapterWithDownload CreateWithDownload() => new();

    /// <summary>Creates a mock that supports permission events.</summary>
    public static MockWebViewAdapterWithPermission CreateWithPermission() => new();

    /// <summary>Creates a mock that supports all three new facets.</summary>
    public static MockWebViewAdapterFull CreateFull() => new();

    /// <summary>Creates a mock that supports editing commands.</summary>
    public static MockWebViewAdapterWithCommands CreateWithCommands() => new();

    /// <summary>Creates a mock that supports screenshot capture.</summary>
    public static MockWebViewAdapterWithScreenshot CreateWithScreenshot() => new();

    /// <summary>Creates a mock that supports PDF printing.</summary>
    public static MockWebViewAdapterWithPrint CreateWithPrint() => new();
}

/// <summary>Mock adapter that also implements <see cref="IWebViewAdapterOptions"/> for environment options testing.</summary>
internal sealed class MockWebViewAdapterWithOptions : MockWebViewAdapter, IWebViewAdapterOptions
{
    public IWebViewEnvironmentOptions? AppliedOptions { get; private set; }
    public string? AppliedUserAgent { get; private set; }
    public int ApplyOptionsCallCount { get; private set; }
    public int SetUserAgentCallCount { get; private set; }

    public void ApplyEnvironmentOptions(IWebViewEnvironmentOptions options)
    {
        ApplyOptionsCallCount++;
        AppliedOptions = options;
    }

    public void SetCustomUserAgent(string? userAgent)
    {
        SetUserAgentCallCount++;
        AppliedUserAgent = userAgent;
    }
}

/// <summary>Mock adapter that also implements <see cref="INativeWebViewHandleProvider"/>.</summary>
internal sealed class MockWebViewAdapterWithHandle : MockWebViewAdapter, INativeWebViewHandleProvider
{
    public IPlatformHandle? HandleToReturn { get; set; }
    public int TryGetHandleCallCount { get; private set; }

    public IPlatformHandle? TryGetWebViewHandle()
    {
        TryGetHandleCallCount++;
        return HandleToReturn;
    }
}

/// <summary>A test typed platform handle implementing <see cref="IWindowsWebView2PlatformHandle"/> for pattern-matching tests.</summary>
public sealed record TestWindowsWebView2PlatformHandle(nint Handle, nint CoreWebView2Handle, nint CoreWebView2ControllerHandle) : IWindowsWebView2PlatformHandle
{
    public string HandleDescriptor => "WebView2";
}

/// <summary>A test typed platform handle implementing <see cref="IAppleWKWebViewPlatformHandle"/> for pattern-matching tests.</summary>
public sealed record TestAppleWKWebViewPlatformHandle(nint WKWebViewHandle) : IAppleWKWebViewPlatformHandle
{
    public nint Handle => WKWebViewHandle;
    public string HandleDescriptor => "WKWebView";
}

/// <summary>A test typed platform handle implementing <see cref="IGtkWebViewPlatformHandle"/> for pattern-matching tests.</summary>
public sealed record TestGtkWebViewPlatformHandle(nint WebKitWebViewHandle) : IGtkWebViewPlatformHandle
{
    public nint Handle => WebKitWebViewHandle;
    public string HandleDescriptor => "WebKitGTK";
}

/// <summary>A test typed platform handle implementing <see cref="IAndroidWebViewPlatformHandle"/> for pattern-matching tests.</summary>
public sealed record TestAndroidWebViewPlatformHandle(nint AndroidWebViewHandle) : IAndroidWebViewPlatformHandle
{
    public nint Handle => AndroidWebViewHandle;
    public string HandleDescriptor => "AndroidWebView";
}

/// <summary>Mock adapter that also implements <see cref="ICustomSchemeAdapter"/> for custom scheme testing.</summary>
internal sealed class MockWebViewAdapterWithCustomSchemes : MockWebViewAdapter, ICustomSchemeAdapter
{
    public IReadOnlyList<CustomSchemeRegistration>? RegisteredSchemes { get; private set; }
    public int RegisterCallCount { get; private set; }

    public void RegisterCustomSchemes(IReadOnlyList<CustomSchemeRegistration> schemes)
    {
        RegisterCallCount++;
        RegisteredSchemes = schemes;
    }
}

/// <summary>Mock adapter that also implements <see cref="IDownloadAdapter"/> for download event testing.</summary>
internal sealed class MockWebViewAdapterWithDownload : MockWebViewAdapter, IDownloadAdapter
{
    public event EventHandler<DownloadRequestedEventArgs>? DownloadRequested;

    public void RaiseDownloadRequested(DownloadRequestedEventArgs args)
        => DownloadRequested?.Invoke(this, args);
}

/// <summary>Mock adapter that also implements <see cref="IPermissionAdapter"/> for permission event testing.</summary>
internal sealed class MockWebViewAdapterWithPermission : MockWebViewAdapter, IPermissionAdapter
{
    public event EventHandler<PermissionRequestedEventArgs>? PermissionRequested;

    public void RaisePermissionRequested(PermissionRequestedEventArgs args)
        => PermissionRequested?.Invoke(this, args);
}

/// <summary>Mock adapter that implements all new facets (ICustomSchemeAdapter, IDownloadAdapter, IPermissionAdapter).</summary>
internal sealed class MockWebViewAdapterFull : MockWebViewAdapter, ICustomSchemeAdapter, IDownloadAdapter, IPermissionAdapter
{
    public IReadOnlyList<CustomSchemeRegistration>? RegisteredSchemes { get; private set; }
    public int RegisterCallCount { get; private set; }
    public event EventHandler<DownloadRequestedEventArgs>? DownloadRequested;
    public event EventHandler<PermissionRequestedEventArgs>? PermissionRequested;

    public void RegisterCustomSchemes(IReadOnlyList<CustomSchemeRegistration> schemes)
    {
        RegisterCallCount++;
        RegisteredSchemes = schemes;
    }

    public void RaiseDownloadRequested(DownloadRequestedEventArgs args)
        => DownloadRequested?.Invoke(this, args);

    public void RaisePermissionRequested(PermissionRequestedEventArgs args)
        => PermissionRequested?.Invoke(this, args);
}

/// <summary>Mock adapter that also implements <see cref="ICommandAdapter"/> for command manager testing.</summary>
internal sealed class MockWebViewAdapterWithCommands : MockWebViewAdapter, ICommandAdapter
{
    public List<WebViewCommand> ExecutedCommands { get; } = new();

    public void ExecuteCommand(WebViewCommand command)
    {
        ExecutedCommands.Add(command);
    }
}

/// <summary>Mock adapter that also implements <see cref="IScreenshotAdapter"/> for screenshot testing.</summary>
internal sealed class MockWebViewAdapterWithScreenshot : MockWebViewAdapter, IScreenshotAdapter
{
    public byte[] ScreenshotResult { get; set; } = new byte[] { 0x89, 0x50, 0x4E, 0x47 }; // PNG magic

    public Task<byte[]> CaptureScreenshotAsync()
    {
        return Task.FromResult(ScreenshotResult);
    }
}

/// <summary>Mock adapter that also implements <see cref="IPrintAdapter"/> for PDF printing testing.</summary>
internal sealed class MockWebViewAdapterWithPrint : MockWebViewAdapter, IPrintAdapter
{
    public byte[] PdfResult { get; set; } = new byte[] { 0x25, 0x50, 0x44, 0x46 }; // %PDF magic

    /// <summary>The last options passed to <see cref="PrintToPdfAsync"/>.</summary>
    public PdfPrintOptions? LastPrintOptions { get; private set; }

    public Task<byte[]> PrintToPdfAsync(PdfPrintOptions? options)
    {
        LastPrintOptions = options;
        return Task.FromResult(PdfResult);
    }
}

/// <summary>Mock adapter that also implements <see cref="ICookieAdapter"/> for cookie management testing.</summary>
internal sealed class MockWebViewAdapterWithCookies : MockWebViewAdapter, ICookieAdapter
{
    public Task<IReadOnlyList<WebViewCookie>> GetCookiesAsync(Uri uri)
    {
        var host = uri.Host;
        var result = CookieStore.Values
            .Where(c => c.Domain.EndsWith(host, StringComparison.OrdinalIgnoreCase) || host.EndsWith(c.Domain, StringComparison.OrdinalIgnoreCase))
            .ToList();
        return Task.FromResult<IReadOnlyList<WebViewCookie>>(result);
    }

    public Task SetCookieAsync(WebViewCookie cookie)
    {
        CookieStore[CookieKey(cookie.Name, cookie.Domain, cookie.Path)] = cookie;
        return Task.CompletedTask;
    }

    public Task DeleteCookieAsync(WebViewCookie cookie)
    {
        CookieStore.Remove(CookieKey(cookie.Name, cookie.Domain, cookie.Path));
        return Task.CompletedTask;
    }

    public Task ClearAllCookiesAsync()
    {
        CookieStore.Clear();
        return Task.CompletedTask;
    }
}
