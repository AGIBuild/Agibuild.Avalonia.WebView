<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:Agibuild.Fulora.Integration.Tests.ViewModels"
             xmlns:agw="using:Agibuild.Fulora"
             xmlns:local="using:Agibuild.Fulora.Integration.Tests"
             mc:Ignorable="d"
             x:Class="Agibuild.Fulora.Integration.Tests.Views.ConsumerWebViewE2EView"
             x:DataType="vm:ConsumerWebViewE2EViewModel"
             Background="{StaticResource SurfaceBgBrush}">

  <DockPanel>

    <!-- ════════════ Top Toolbar (always visible) ════════════ -->
    <Border DockPanel.Dock="Top" Background="White"
            BorderThickness="0,0,0,1" BorderBrush="{StaticResource BorderDefaultBrush}"
            Padding="6,4">
      <Grid ColumnDefinitions="Auto,Auto,Auto,*,Auto,Auto">
        <!-- Toggle left panel -->
        <ToggleButton x:Name="ToolsToggle" Grid.Column="0"
                      IsChecked="False"
                      Content="&#x2630;" ToolTip.Tip="Tools"
                      FontSize="14" Padding="8,5"
                      Background="Transparent" BorderThickness="0"
                      CornerRadius="6" VerticalAlignment="Center" />

        <!-- Nav buttons -->
        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="2" Margin="4,0">
          <Button Classes="toolbar-btn" Content="&#x25C0;" ToolTip.Tip="Back"
                  Command="{Binding GoBackCommand}" IsEnabled="{Binding CanGoBack}" />
          <Button Classes="toolbar-btn" Content="&#x25B6;" ToolTip.Tip="Forward"
                  Command="{Binding GoForwardCommand}" IsEnabled="{Binding CanGoForward}" />
          <Button Classes="toolbar-btn" Content="&#x27F3;" ToolTip.Tip="Refresh"
                  Command="{Binding DoRefreshCommand}" />
        </StackPanel>

        <TextBlock Grid.Column="2" Text="&#x23F3;" FontSize="12"
                   IsVisible="{Binding IsPageLoading}"
                   Foreground="{StaticResource BrandAccentBrush}"
                   VerticalAlignment="Center" Margin="4,0" />

        <!-- Address bar -->
        <Border Grid.Column="3" CornerRadius="8"
                BorderThickness="1" BorderBrush="{StaticResource BorderDefaultBrush}"
                Background="#F8FAFC" Margin="4,2">
          <TextBox Text="{Binding AddressText, Mode=TwoWay}"
                   Watermark="Enter URL..."
                   FontSize="12" Padding="8,5"
                   Background="Transparent" BorderThickness="0"
                   CornerRadius="8" KeyDown="OnAddressKeyDown" />
        </Border>

        <Button Grid.Column="4" Content="Go" Padding="10,5" CornerRadius="6"
                FontSize="12" Command="{Binding GoToAddressCommand}" Margin="4,0" />

        <Button Grid.Column="5" Classes="primary"
                Content="&#x25B6; E2E"
                Command="{Binding RunAllCommand}"
                Padding="10,5" FontSize="11" />
      </Grid>
    </Border>

    <!-- ════════════ Status bar (hidden on mobile to save vertical space) ════════════ -->
    <Border DockPanel.Dock="Bottom" Background="White"
            BorderThickness="0,1,0,0" BorderBrush="{StaticResource BorderDefaultBrush}"
            Padding="8,3"
            IsVisible="{x:Static local:PlatformHelper.IsDesktop}">
      <TextBlock Text="{Binding Status}" Classes="caption" />
    </Border>

    <!-- ════════════ Content: Left Panel + WebView ════════════ -->
    <Grid ColumnDefinitions="Auto,*">

      <!-- Left tools panel (inline, collapsible) -->
      <Border Grid.Column="0" Width="260"
              IsVisible="{Binding #ToolsToggle.IsChecked}"
              Background="White"
              BorderThickness="0,0,1,0" BorderBrush="{StaticResource BorderDefaultBrush}">
        <ScrollViewer Margin="10,8">
          <StackPanel Spacing="10">

            <!-- JavaScript -->
            <Border Classes="card">
              <StackPanel Spacing="6">
                <TextBlock Text="JavaScript" Classes="subheading" />
                <TextBox Classes="mono"
                         Text="{Binding ScriptInput, Mode=TwoWay}"
                         Watermark="document.title"
                         AcceptsReturn="True" MinHeight="50"
                         KeyDown="OnScriptKeyDown" />
                <Grid ColumnDefinitions="*,Auto">
                  <Border Grid.Column="0" Background="#F0FDF4" CornerRadius="6"
                          Padding="6,3"
                          IsVisible="{Binding ScriptResult, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                    <TextBlock Text="{Binding ScriptResult}"
                               FontFamily="Menlo,Consolas,monospace" FontSize="11"
                               Foreground="{StaticResource BrandSuccessBrush}"
                               TextWrapping="Wrap" />
                  </Border>
                  <Button Grid.Column="1" Classes="primary"
                          Content="Run" Padding="10,5" FontSize="11"
                          Command="{Binding RunScriptCommand}" Margin="6,0,0,0" />
                </Grid>
              </StackPanel>
            </Border>

            <!-- Load HTML -->
            <Border Classes="card">
              <StackPanel Spacing="6">
                <TextBlock Text="Load HTML" Classes="subheading" />
                <TextBox Classes="mono"
                         Text="{Binding HtmlInput, Mode=TwoWay}"
                         Watermark="&lt;html&gt;...&lt;/html&gt;"
                         AcceptsReturn="True" MinHeight="50" />
                <Button Classes="primary" Content="Load HTML"
                        HorizontalAlignment="Right" Padding="10,5" FontSize="11"
                        Command="{Binding LoadHtmlCommand}" />
              </StackPanel>
            </Border>

          </StackPanel>
        </ScrollViewer>
      </Border>

      <!-- WebView (fills remaining space) -->
      <agw:WebView Grid.Column="1" x:Name="WebViewControl" />

    </Grid>
  </DockPanel>
</UserControl>
