<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net10.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="..\Agibuild.Avalonia.WebView.Core\Agibuild.Avalonia.WebView.Core.csproj" />
    <ProjectReference Include="..\Agibuild.Avalonia.WebView.Adapters.Abstractions\Agibuild.Avalonia.WebView.Adapters.Abstractions.csproj" />
  </ItemGroup>

  <ItemGroup>
    <None Include="Native/WkWebViewShim.mm" />
  </ItemGroup>

  <ItemGroup>
    <!-- Legacy file was previously generated by bindings-based adapter; keep it out of compilation. -->
    <Compile Remove="MacOSWebViewAdapter.cs" />
  </ItemGroup>

  <PropertyGroup Condition="$([MSBuild]::IsOSPlatform('osx'))">
    <AgWkShimLibName>libAgibuildWebViewWk.dylib</AgWkShimLibName>
  </PropertyGroup>

  <Target Name="BuildWkShim" BeforeTargets="Build"
          Condition="$([MSBuild]::IsOSPlatform('osx'))">
    <PropertyGroup>
      <_AgWkShimOutDir>$(TargetDir)runtimes/osx/native/</_AgWkShimOutDir>
      <_AgWkShimOutPath>$(_AgWkShimOutDir)$(AgWkShimLibName)</_AgWkShimOutPath>
    </PropertyGroup>

    <MakeDir Directories="$(_AgWkShimOutDir)" />
    <Exec Command="xcrun clang++ -fobjc-arc -std=c++17 -dynamiclib &quot;$(MSBuildProjectDirectory)/Native/WkWebViewShim.mm&quot; -o &quot;$(_AgWkShimOutPath)&quot; -framework Foundation -framework AppKit -framework WebKit -arch arm64 -arch x86_64"
          WorkingDirectory="$(MSBuildProjectDirectory)" />
    <!-- Ad-hoc sign the dylib so macOS system policy allows loading it. -->
    <Exec Command="codesign -s - -f &quot;$(_AgWkShimOutPath)&quot;" />
  </Target>
</Project>
