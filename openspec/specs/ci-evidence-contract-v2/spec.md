# ci-evidence-contract-v2 Specification

## Purpose
Define the CI evidence contract v2 schema and provenance requirements for governed release evidence artifacts, enabling machine-auditable test summaries, coverage summaries, and source artifact lineage in `CiPublish` outputs.
## Requirements
### Requirement: Release evidence snapshot SHALL use explicit schema version v2
Governed release evidence artifacts in `CiPublish` MUST include an explicit `schemaVersion` field set to `2` and MUST expose deterministic core fields for test summary, coverage summary, and source artifact references.

#### Scenario: CiPublish writes v2 evidence artifact
- **WHEN** `CiPublish` completes governed validation targets
- **THEN** emitted evidence includes `schemaVersion = 2` and all required core sections

#### Scenario: Missing schema version fails governance
- **WHEN** an evidence artifact is missing `schemaVersion` or declares a non-v2 value
- **THEN** governance rejects the artifact with deterministic schema diagnostics

### Requirement: CI evidence v2 SHALL include provenance metadata
Evidence v2 MUST include provenance fields that identify lane context, producer target, and source artifact lineage needed for machine auditing.

#### Scenario: Provenance fields are complete
- **WHEN** governance validates v2 evidence
- **THEN** lane context and source lineage metadata are present and non-empty

#### Scenario: Incomplete provenance fails gate
- **WHEN** any required provenance field is missing or empty
- **THEN** governance fails before release-readiness sign-off

### Requirement: Closeout snapshot reflects current phase evidence

The closeout snapshot generated by `ReleaseCloseoutSnapshot` SHALL include evidence from the completed phase (Phase 8) including updated test counts, coverage percentages, and governance outcomes.

#### Scenario: Closeout snapshot is regenerated after Phase 8 closeout

- **WHEN** `nuke ReleaseCloseoutSnapshot` runs after Phase 8 transition markers are updated
- **THEN** the generated `closeout-snapshot.json` SHALL contain current unit test count, integration test count, line coverage percentage, and branch coverage percentage
- **AND** all governance sections SHALL show pass state

### Requirement: Evidence v2 SHALL NOT require full upstream artifact hashes
Evidence v2 MUST NOT require content-hash fields for every upstream artifact, and SHALL keep provenance requirements limited to release-critical lineage fields.

#### Scenario: Release evidence is valid without full upstream hashes
- **WHEN** `CiPublish` evidence omits non-release-critical upstream artifact hashes
- **THEN** governance validation still passes if required v2 provenance fields are present

### Requirement: Evidence v2 closeout transition metadata SHALL be lane-provenance consistent
Closeout snapshot artifacts governed by CI evidence contract v2 MUST ensure transition metadata (`completedPhase`, `activePhase`) is consistent with provenance lane context and producer target semantics.

#### Scenario: Lane-provenance consistency passes
- **WHEN** closeout snapshot v2 metadata is validated
- **THEN** transition metadata and provenance fields are mutually consistent for the producing lane context

#### Scenario: Lane-provenance inconsistency fails gate
- **WHEN** transition metadata conflicts with provenance lane context or producer target semantics
- **THEN** evidence governance fails deterministically with expected-vs-actual diagnostics

### Requirement: Evidence v2 transition metadata SHALL match roadmap machine-checkable phase state
Closeout snapshot v2 transition fields MUST match the repository roadmap machine-checkable transition section for completed and active phase identifiers.

#### Scenario: Snapshot phase ids match roadmap state
- **WHEN** governance compares closeout snapshot transition metadata with roadmap machine-checkable transition state
- **THEN** evidence validation passes

#### Scenario: Snapshot phase ids drift from roadmap state
- **WHEN** completed or active phase identifiers in the snapshot diverge from roadmap machine-checkable transition state
- **THEN** evidence governance fails before release-readiness sign-off

### Requirement: CI evidence v2 SHALL include release decision summary
Release evidence under contract v2 MUST include a release decision summary section with deterministic `state` and timestamped evaluation context.

#### Scenario: Ready decision summary is present
- **WHEN** release orchestration passes all governed checks
- **THEN** v2 evidence contains decision summary with `state = ready` and non-empty evaluation context

#### Scenario: Blocked decision summary is present
- **WHEN** release orchestration blocks publication
- **THEN** v2 evidence contains decision summary with `state = blocked` and blocking reason references

### Requirement: CI evidence v2 blocked summaries SHALL carry structured reason entries
When release decision summary state is `blocked`, the evidence payload MUST include structured blocking reason entries with category, invariant/source reference, and expected-vs-actual fields.

#### Scenario: Blocking reasons are machine-auditable
- **WHEN** consumers parse blocked release evidence
- **THEN** they can deterministically identify blocking categories and sources without free-text parsing

### Requirement: CI evidence v2 SHALL include distribution-readiness summary
CI evidence contract v2 MUST include a structured distribution-readiness summary section containing deterministic status, lane context, and report linkage.

#### Scenario: Distribution summary is present in evidence payload
- **WHEN** release evidence v2 is generated for `CiPublish`
- **THEN** payload contains non-empty distribution readiness section with deterministic state and source artifact reference

### Requirement: CI evidence v2 SHALL expose distribution failure entries as structured data
When distribution readiness fails, evidence payload MUST expose structured failure entries with stable categories and expected-vs-actual details.

#### Scenario: Distribution failure entries are machine-auditable
- **WHEN** distribution readiness state is failed
- **THEN** evidence payload includes structured failure entries that do not require free-text parsing

### Requirement: CI evidence v2 SHALL include adoption-readiness summary
CI evidence contract v2 MUST include structured adoption-readiness summary fields with deterministic state, blocking/advisory counts, and source report linkage.

#### Scenario: Adoption summary is present in release evidence
- **WHEN** `CiPublish` emits release evidence v2
- **THEN** payload includes non-empty adoption readiness summary with deterministic status fields

### Requirement: CI evidence v2 SHALL include adoption finding entries when non-passing
When adoption readiness includes non-passing signals, evidence payload MUST include structured finding entries with policy tier and expected-vs-actual details.

#### Scenario: Adoption finding entries are machine-readable
- **WHEN** adoption readiness contains blocking or advisory findings
- **THEN** evidence payload includes structured entries that can be parsed without free-text interpretation

